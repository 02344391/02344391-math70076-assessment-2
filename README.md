# 02344391-math70076-assessment-2
# Handling of categorical variables for calculating SHAP values in the case of tree-based methods.
## Description

In this project, we focus on the explainability of machine learning models using SHAP values. Specifically, our aim is to compute the SHAP values for tree-based methods and ensemble methods that incorporate categorical features. 

Categorical features are commonly encoded using One-hot encoding. Consequently, additional features are introduced into the model, and explainer models assign them their own SHAP values. One approach to grasp the contribution of the original categorical feature is to aggregate all the SHAP values of the encoded subfeatures. However, calculating SHAP values for each subfeature may lack statistical rigor. Even if we assume independence among all initial features of the model, treating encoded subfeatures as independent is illogical.

We then modify the script of the SHAP module to consider the variables obtained by one-hot encoding of a categorical variable as a whole.

The goal of this project is to compare the two methods of handling categorical variables to see if we obtain similar results.

## Resources needed

This project is entirely developed in Python and requires the installation of several libraries listed below:
- sys (add file paths);
- os (get valid paths for files);
- numpy (calculations and data handling);
- pandas (data handling);
- matplotlib (for every plot);
- seaborn (plots and dataset);
- pickle (save/load Python objects);
- sklearn (models, preprocessing, scores...);
- shap (explainer).


## Inventory of files

This file contains 6 main folders that may contain files or other folders. 
It is important to maintain the relative hierarchy of these folders and files for the proper functioning of the code scripts.

### *analyses/*

It contains the main script to build the report: *categorical_shap_analyses.py*. It calls the scripts from *src/helper-functions*, and imports the dataset *titanic.csv* to conduct the study of different methods for calculating SHAP values.

### *data/*

*data/* is divided into two subfolders: *data/raw* and *data/derived*.
- *data/raw* contains the raw data of the Titanic dataset of seaborn: *titanic.csv*;
- *data/derived* contains the dataset *titanic_cleaned.csv*, which is the cleaned version of *titanic.csv* with the relevant columns for this project.

### *outputs/*
*outputs/* is divided into two subfolders: *outputs/comparison-shap* and *outputs/plot_tree*.
- *outputs/comparison-shap* contains two folders: *data* and *figures*. *outputs/comparison-shap/data* stores the *Python* dictionaries generated by the script in the *analysis* directory containing the essential information for creating the report. Indeed, *Python*-coded algorithms are slow, and it is necessary to keep the calculated values to avoid recalculating them. These *Python* objects are *pickle* files (.pkl). *outputs/comparison-shap/figures* contains all the figures used in the report two compare both methods  for calculating the SHAP values;
- *outputs/plot_tree* contains one folder: *figures*. It contains the figures of tree paths used in the first part example of the report.

### *reports/*

*reports/* contains the LateX file for generating the report, the bibTeX bibliography and the PDF version of the report. The report is divided into three parts: a first part using a simple example illustring the differences between the SHAP values between the two methods. The second part is the analysis of the two methods on artificially generated datasets with different number of categorical features. The final part is a real case application on the Titanic dataset.

### *scr/*

*scr/* contains the folders *data-transform* and *helper-functions*:
- *scr/data-transform* contains all the scripts necessary to produce the Titanic dataset used in the last part of the report:
  - *import_data_titanic.py* imports the Titanic dataset from *seaborn* and save it in *data/raw;
  - *clean_titanic.py* transforms the Titanic dataset as wanted in the report and save it in *data/derived*;
- *scr/helper-functions* contains scripts used in the *analyses* script:
  - *create_categories.py* contains a function for transforming numerical features into categorical features;
  - *plot_tree_path.py* contains functions for plotting paths of an input with some unknown features descending a decision tree, it is used in the first part of the report.
  - *tree_shap.py* contains the main class to compute SHAP of encoded categorical subfeatures as a whole. It is a modification of the *Python* script *_tree.py* of the *shap* module (https://github.com/shap/shap/blob/master/shap/explainers/_tree.py). It contains also functions for summing shap values of encoded subfeatures, computing normalised absolute values of SHAP values or plotting importance barplots using SHAP values.

### *tests/*

*tests/* contains the *helper-functions* folder. Its purpose is to test the functions of the scripts in this folder and ensure they work. To do this, you just need to run the scripts associated with the scripts in the *scr/* folder.


## License:

Modification of the shap module:

https://github.com/shap

The MIT License (MIT)

Copyright (c) 2018 Scott Lundberg

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.